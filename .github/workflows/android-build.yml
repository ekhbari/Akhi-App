name: Build Android APK

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache Android SDK (runner temp) 
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/android-sdk
          key: android-sdk-${{ runner.os }}-buildtools-36-ndk-25

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-cache-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}

      - name: Install apt packages
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            curl unzip wget openjdk-17-jdk build-essential zip

      - name: Export Android SDK env (runtime)
        run: |
          echo "ANDROID_SDK_ROOT=$RUNNER_TEMP/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$RUNNER_TEMP/android-sdk/ndk" >> $GITHUB_ENV
          echo "$RUNNER_TEMP/android-sdk/cmdline-tools/latest/bin:$RUNNER_TEMP/android-sdk/platform-tools:$PATH" >> $GITHUB_PATH

      - name: Download Android command-line tools (if missing)
        run: |
          mkdir -p "$RUNNER_TEMP/android-sdk/cmdline-tools"
          if [ ! -d "$RUNNER_TEMP/android-sdk/cmdline-tools/latest" ]; then
            cd "$RUNNER_TEMP"
            curl -fSL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o commandlinetools.zip
            unzip -q commandlinetools.zip -d "$RUNNER_TEMP/android-sdk/cmdline-tools"
            if [ -d "$RUNNER_TEMP/android-sdk/cmdline-tools/cmdline-tools" ]; then
              mv "$RUNNER_TEMP/android-sdk/cmdline-tools/cmdline-tools" "$RUNNER_TEMP/android-sdk/cmdline-tools/latest"
            else
              mv "$RUNNER_TEMP/android-sdk/cmdline-tools/"* "$RUNNER_TEMP/android-sdk/cmdline-tools/latest" || true
            fi
          fi

      - name: Ensure sdkmanager and accept licenses
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
        run: |
          set -e
          sdkmanager --version
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

      - name: Install SDK components (platform-tools, platforms, build-tools, ndk)
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
        run: |
          set -e
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;36.1.0" "ndk;25.2.9519653"

      - name: Symlink SDK to Buildozer expected path
        run: |
          ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          BUILDOBZER_SDK_DIR="$HOME/.buildozer/android/platform/android-sdk"
          mkdir -p "$(dirname "$BUILDOBZER_SDK_DIR")"
          ln -sfn "$ANDROID_SDK_ROOT" "$BUILDOBZER_SDK_DIR"

      - name: Install Python build tools (buildozer, cython)
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel
          pip install buildozer==1.5.0 cython==0.29.36

      - name: Create buildozer.spec if missing
        run: |
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi

      - name: Run Buildozer (build debug)
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
        run: |
          export PATH="$RUNNER_TEMP/android-sdk/cmdline-tools/latest/bin:$RUNNER_TEMP/android-sdk/platform-tools:$PATH"
          buildozer -v android debug

      - name: Upload APK artifact (v4)
        uses: actions/upload-artifact@v4
        with:
          name: AkhiManga-apk
          path: bin/*.apk
          
